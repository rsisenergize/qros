name: "Deploy Composite"
description: "Reusable deployment step for Laravel apps via SCP + SSH to cPanel"

inputs:
  env-name:
    description: "Environment name (dev/test/preprod/prod)"
    required: true
  env-file:
    description: "Path to environment file"
    required: true
  ssh-host:
    description: "Server SSH host"
    required: true
  ssh-user:
    description: "Server SSH username"
    required: true
  ssh-key:
    description: "Private SSH key"
    required: true
  deploy-path:
    description: "Target deployment path on server"
    required: true

runs:
  using: "composite"
  steps:
    # 1ï¸âƒ£ Setup SSH key
    - name: "ğŸ” Setup SSH Key"
      shell: bash
      run: |
        mkdir -p ~/.ssh
        echo "${{ inputs.ssh-key }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ inputs.ssh-host }} >> ~/.ssh/known_hosts 2>/dev/null || true

    # 2ï¸âƒ£ Upload deployment files via SCP
    - name: "ğŸ“¤ Upload Deployment Files via SCP"
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ inputs.ssh-host }}
        username: ${{ inputs.ssh-user }}
        key: ${{ inputs.ssh-key }}
        source: "deploy-artifact/*"
        target: ${{ inputs.deploy-path }}
        strip_components: 1
        rm: false
        overwrite: true

    # 3ï¸âƒ£ Run Laravel commands via SSH
    - name: "âš™ï¸ Run Laravel Commands on Server"
      shell: bash
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ inputs.ssh-user }}@${{ inputs.ssh-host }} << 'EOF'
        set -e
        
        echo "ğŸ“ Navigating to deployment directory..."
        cd ${{ inputs.deploy-path }}

        # Maintenance mode only for production
        if [[ "${{ inputs.env-name }}" == "prod" ]]; then
          echo "ğŸ”’ Enabling maintenance mode..."
          php artisan down --refresh=15 --retry=60 || true
        fi

        # Ensure directories exist with proper structure
        echo "ğŸ“ Creating required directories..."
        mkdir -p bootstrap/cache
        mkdir -p storage/framework/sessions
        mkdir -p storage/framework/views
        mkdir -p storage/framework/cache/data
        mkdir -p storage/logs
        mkdir -p storage/app/public
        
        # Set permissions (adjust if cPanel restricts this)
        echo "ğŸ”§ Setting permissions..."
        chmod -R 775 storage bootstrap/cache 2>/dev/null || true
        
        # Try to set ownership if possible (may fail on cPanel, that's OK)
        if command -v chown &> /dev/null; then
          chown -R ${{ inputs.ssh-user }}:${{ inputs.ssh-user }} storage bootstrap/cache 2>/dev/null || true
        fi

        # Laravel setup commands
        echo "ğŸ”— Creating storage link..."
        php artisan storage:link || true

        echo "ğŸ—„ï¸ Running database migrations..."
        php artisan migrate --force

        echo "ğŸ§¹ Clearing all caches..."
        php artisan cache:clear
        php artisan config:clear
        php artisan route:clear
        php artisan view:clear

        echo "âš¡ Caching configuration..."
        php artisan config:cache

        echo "ğŸ‘ï¸ Caching views..."
        php artisan view:cache
        
        # Only cache routes in production (route caching can cause issues)
        if [[ "${{ inputs.env-name }}" == "prod" ]]; then
          echo "ğŸ›£ï¸ Caching routes..."
          php artisan route:cache
        else
          echo "â„¹ï¸ Skipping route cache for non-production environment"
        fi

        # Bring production back online
        if [[ "${{ inputs.env-name }}" == "prod" ]]; then
          echo "ğŸ”“ Disabling maintenance mode..."
          php artisan up || true
        fi

        echo "âœ… Deployment completed successfully for ${{ inputs.env-name }} environment"
        EOF

    # 4ï¸âƒ£ Cleanup SSH key
    - name: "ğŸ§¹ Cleanup SSH Key"
      shell: bash
      if: always()
      run: |
        rm -f ~/.ssh/id_rsa